name: Build Release Binaries

on:
  push:
    tags:
      - unleash-yggdrasil-*
  workflow_dispatch:

jobs:
  build-binaries:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        include:
          - os: ubuntu-latest
            target: x86_64-unknown-linux-gnu
            output: libyggdrasilffi.so
            name: libyggdrasilffi_x86_64.so
            cross: false
          - os: ubuntu-latest
            target: aarch64-unknown-linux-gnu
            output: libyggdrasilffi.so
            name: libyggdrasilffi_arm64.so
            cross: true
          - os: ubuntu-latest
            target: aarch64-unknown-linux-musl
            output: libyggdrasilffi.so
            name: libyggdrasilffi_aarch64.so
            cross: true
          - os: windows-latest
            target: x86_64-pc-windows-gnu
            output: yggdrasilffi.dll
            name: libyggdrasilffi_x86_64.dll
            cross: false
          - os: windows-latest
            target: aarch64-pc-windows-msvc
            output: yggdrasilffi.dll
            name: libyggdrasilffi_arm64.dll
            cross: false
          - os: macos-13
            target: x86_64-apple-darwin
            output: libyggdrasilffi.dylib
            name: libyggdrasilffi_x86_64.dylib
            cross: false
          - os: macos-latest
            target: aarch64-apple-darwin
            output: libyggdrasilffi.dylib
            name: libyggdrasilffi_arm64.dylib
            cross: false

    steps:
    - uses: actions/checkout@v4

    - name: Install cross (if needed)
      if: ${{ matrix.cross == true }}
      run: cargo install cross

    - name: Install rust
      run: |
        rustup set auto-self-update disable
        rustup toolchain install stable --profile default
        rustup show

    - name: Rust cache
      uses: Swatinem/rust-cache@v2

    - name: Build Rust Library (Cross)
      if: ${{ matrix.cross == true }}
      run: cross build -p yggdrasilffi --release --target ${{ matrix.target }};

    - name: Build Rust Library (Cargo)
      if: ${{ matrix.cross == false }}
      run: cargo build -p yggdrasilffi --release --target ${{ matrix.target }};

    - name: Rename Output Binary
      run: |
        mv target/${{ matrix.target }}/release/${{ matrix.output }} target/${{ matrix.target }}/release/${{ matrix.name }}

    - name: Get Release by Tag
      id: get_release
      uses: actions/github-script@v5
      with:
        script: |
          const tag = context.ref.replace("refs/tags/", "");
          const releases = await github.repos.listReleases({
            owner: context.repo.owner,
            repo: context.repo.repo,
          });
          const release = releases.data.find(r => r.tag_name === tag);
          if (release) {
            return { release_id: release.id };
          } else {
            throw new Error(`Release with tag ${tag} not found.`);
          }
        result-encoding: json

