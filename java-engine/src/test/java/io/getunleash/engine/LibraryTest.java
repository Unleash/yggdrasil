/*
 * This Java source file was generated by the Gradle 'init' task.
 */
package io.getunleash.engine;

import java.time.Instant;
import java.time.ZoneOffset;
import java.time.ZonedDateTime;
import org.junit.jupiter.api.Test;

public class LibraryTest {
  @Test
  public void engineCanBeNewedUpWithoutError() throws Exception {
    new UnleashEngine();
  }

  @Test
  public void takeStateLoadsJsonCorrectly() throws Exception {
    UnleashEngine engine = new UnleashEngine();

    String path = "../test-data/simple.json";
    String json = new String(java.nio.file.Files.readAllBytes(java.nio.file.Paths.get(path)));
    engine.takeState(json);
  }

  @Test
  public void isEnabledReturnsCorrectResult() throws Exception {
    UnleashEngine engine = new UnleashEngine();

    String path = "../test-data/simple.json";
    String json = new String(java.nio.file.Files.readAllBytes(java.nio.file.Paths.get(path)));
    engine.takeState(json);
    WasmResponse<Boolean> result = engine.isEnabled("Feature.A", new Context());
    assert (result.value == true);
  }

  @Test
  public void getMetricsReturnsCorrectResult() throws Exception {
    UnleashEngine engine = new UnleashEngine();
    String path = "../test-data/simple.json";
    String json = new String(java.nio.file.Files.readAllBytes(java.nio.file.Paths.get(path)));
    engine.takeState(json);
    engine.isEnabled("Feature.A", new Context());
    engine.isEnabled("Feature.C", new Context());
    engine.isEnabled("Feature.C", new Context());
    MetricsBucket bucket = engine.getMetrics();
    FeatureCount featA = bucket.getToggles().get("Feature.A");
    FeatureCount featC = bucket.getToggles().get("Feature.C");
    assert (featA.getYes() == 1);
    assert (featC.getYes() == 2);
  }

  @Test
  public void metricsBucketStartStopAreCorrect() throws Exception {
    UnleashEngine engine = new UnleashEngine();
    String path = "../test-data/simple.json";
    String json = new String(java.nio.file.Files.readAllBytes(java.nio.file.Paths.get(path)));
    engine.takeState(json);
    engine.isEnabled("Feature.A", new Context());
    MetricsBucket bucket = engine.getMetrics();

    ZonedDateTime now = ZonedDateTime.now(ZoneOffset.UTC);

    Instant start = bucket.getStart();
    ZonedDateTime utcStart = start.atZone(ZoneOffset.UTC);

    Instant stop = bucket.getStop();
    ZonedDateTime utcStop = stop.atZone(ZoneOffset.UTC);

    assert (utcStart.isBefore(now))
        : "start not before now. start: " + utcStart + " - stop: " + utcStop;
    assert (utcStart.plusMinutes(1).isAfter(now))
        : "start plus minute not after now. start: " + utcStart + " - stop: " + utcStop;
    assert (utcStop.isBefore(now)) : "stop not before now";
    assert (utcStop.plusMinutes(1).isAfter(now)) : "stop plus minute not after now" + utcStop;
  }

  @Test
  public void getEmptyMetricsBucketReturnsNull() throws Exception {
    UnleashEngine engine = new UnleashEngine();
    String path = "../test-data/simple.json";
    String json = new String(java.nio.file.Files.readAllBytes(java.nio.file.Paths.get(path)));
    engine.takeState(json);
    MetricsBucket bucket = engine.getMetrics();
    assert (bucket == null);
  }
}
